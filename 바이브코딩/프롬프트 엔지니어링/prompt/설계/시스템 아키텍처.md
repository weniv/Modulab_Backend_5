# 시스템 아키텍처 설계 프롬프트

## 프로젝트 정보
- 프로젝트명: Django 동영상 스트리밍 플랫폼

## 요청 템플릿

```
Django 온라인 강의 플랫폼의 시스템 아키텍처를 설계해주세요.

[예상 트래픽]:
[주요 기능]:
[비기능 요구사항]:

답변 형식:
# 시스템 아키텍처 설계

## 1. 아키텍처 개요
### 1.1 아키텍처 스타일
- **패턴:** Microservices / Monolithic / Hybrid
- **이유:** [선택한 패턴의 근거]

### 1.2 핵심 설계 원칙
- Scalability (확장성)
- Reliability (안정성)
- Performance (성능)
- Security (보안)
- Maintainability (유지보수성)

## 2. 시스템 구성도
```
┌─────────────────────────────────────────────────────────────┐
│                         Client Layer                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │   Web    │  │  Mobile  │  │   iOS    │  │ Android  │   │
│  │  Browser │  │    App   │  │   App    │  │   App    │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      │ HTTPS
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                       CDN Layer                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  CloudFront / CloudFlare (Static Assets + Videos)   │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                    Load Balancer Layer                       │
│  ┌──────────────────────────────────────────────────────┐  │
│  │       ALB (Application Load Balancer)                │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ▼             ▼             ▼
┌──────────────────────────────────────────────────────────────┐
│                   Application Layer                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Django    │  │   Django    │  │   Django    │         │
│  │  Instance 1 │  │  Instance 2 │  │  Instance N │         │
│  │  (Gunicorn) │  │  (Gunicorn) │  │  (Gunicorn) │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└──────────────┬───────────────────────────────────────────────┘
               │
               │
      ┌────────┼────────┬─────────────┬──────────────┐
      │        │        │             │              │
      ▼        ▼        ▼             ▼              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Data Layer                              │
│  ┌─────────┐  ┌─────────┐  ┌──────────┐  ┌──────────┐     │
│  │  RDS    │  │  Redis  │  │   S3     │  │ElasticS. │     │
│  │(Primary)│  │ (Cache) │  │(Storage) │  │ (Search) │     │
│  └────┬────┘  └─────────┘  └──────────┘  └──────────┘     │
│       │                                                      │
│  ┌────▼────┐                                                │
│  │  RDS    │                                                │
│  │(Replica)│                                                │
│  └─────────┘                                                │
└─────────────────────────────────────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────────────┐
│                  Background Processing                       │
│  ┌─────────┐  ┌─────────┐  ┌─────────────────────────┐    │
│  │ Celery  │  │ Celery  │  │     Message Queue       │    │
│  │Worker 1 │  │Worker N │  │  (Redis / RabbitMQ)     │    │
│  └─────────┘  └─────────┘  └─────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────────────┐
│                 External Services                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  Email   │  │ Payment  │  │  Video   │  │Analytics │   │
│  │ Service  │  │ Gateway  │  │Processing│  │ Service  │   │
│  │(SendGrid)│  │ (Stripe) │  │(FFmpeg)  │  │(Mixpanel)│   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 3. 계층별 상세 설계

### 3.1 프론트엔드 레이어
#### 웹 애플리케이션
- **기술 스택:** React / Vue.js / Next.js
- **상태 관리:** Redux / Vuex / Zustand
- **UI 프레임워크:** Tailwind CSS / Material-UI
- **빌드 도구:** Webpack / Vite

#### 모바일 애플리케이션
- **iOS:** Swift / SwiftUI
- **Android:** Kotlin / Jetpack Compose
- **크로스 플랫폼:** React Native / Flutter (선택사항)

#### 비디오 플레이어
- **라이브러리:** Video.js / Plyr / Custom HLS Player
- **스트리밍 프로토콜:** HLS (HTTP Live Streaming)
- **기능:**
  - 재생 속도 조절 (0.5x ~ 2x)
  - 자막 지원
  - 화질 자동/수동 조절
  - 마지막 재생 위치 기억
  - 10초 앞으로/뒤로

### 3.2 CDN 레이어
#### 정적 자산 배포
- **서비스:** CloudFront (AWS) / CloudFlare
- **캐싱 전략:**
  - HTML: 5분
  - CSS/JS: 1년 (버전 해시 사용)
  - 이미지: 1주일
  - 비디오: 1개월

#### 비디오 스트리밍
- **원본 저장소:** S3 (AWS) / Cloud Storage (GCP)
- **트랜스코딩:** AWS MediaConvert / FFmpeg
- **해상도:** 360p, 480p, 720p, 1080p
- **포맷:** HLS (.m3u8 + .ts segments)

### 3.3 로드 밸런서
- **서비스:** AWS ALB / Nginx
- **알고리즘:** Round Robin / Least Connections
- **Health Check:** /health endpoint
- **SSL/TLS:** HTTPS 강제, TLS 1.2+
- **기능:**
  - Sticky Sessions
  - WebSocket 지원
  - Rate Limiting

### 3.4 애플리케이션 레이어
#### Django 애플리케이션
- **WSGI 서버:** Gunicorn
- **비동기 처리:** Celery + Redis/RabbitMQ
- **API 프레임워크:** Django REST Framework
- **인증:** JWT (djangorestframework-simplejwt)
- **권한:** Django Permissions + Custom Permissions

#### 서비스 구조
```python
project/
├── apps/
│   ├── users/          # 사용자 관리
│   ├── courses/        # 강의 관리
│   ├── enrollments/    # 수강 등록
│   ├── videos/         # 비디오 스트리밍
│   ├── payments/       # 결제 처리
│   └── reviews/        # 리뷰 관리
├── core/               # 공통 유틸리티
├── config/             # 설정 파일
└── celery_app/         # Celery 설정
```

#### Auto Scaling 전략
- **지표:** CPU 사용률 70% 이상
- **최소 인스턴스:** 2개
- **최대 인스턴스:** 10개
- **Scale Out:** CPU > 70% for 5분
- **Scale In:** CPU < 30% for 10분

### 3.5 데이터베이스 레이어
#### PostgreSQL (RDS)
- **Primary-Replica 구조**
- **Primary:** Write 작업
- **Replica:** Read 작업 (최대 5개)
- **연결 풀:** PgBouncer (최대 100 연결)
- **백업:**
  - 자동 백업: 매일 03:00 AM
  - 스냅샷: 주간 (일요일)
  - 보관 기간: 30일

#### Redis (ElastiCache)
- **용도:**
  - 세션 저장소
  - 캐시 레이어
  - Celery 브로커/백엔드
  - Rate Limiting
- **클러스터 모드:** 3 노드 (HA 구성)
- **TTL 전략:**
  - 사용자 세션: 7일
  - API 응답 캐시: 5분~1시간
  - 조회수 카운터: 실시간

#### Elasticsearch
- **용도:** 강의 검색, 로그 분석
- **노드 구성:** 3개 (마스터 1 + 데이터 2)
- **인덱스:**
  - courses: 강의 정보
  - logs: 애플리케이션 로그
- **샤드:** 5개, 레플리카: 1개

### 3.6 스토리지 레이어
#### S3 (Object Storage)
- **버킷 구조:**
  - `videos-raw`: 원본 비디오 (업로드)
  - `videos-processed`: 트랜스코딩된 비디오
  - `thumbnails`: 썸네일 이미지
  - `attachments`: 강의 자료
  - `backups`: 데이터베이스 백업

- **라이프사이클 정책:**
  - `videos-raw`: 30일 후 Glacier로 이동
  - `backups`: 90일 후 삭제

- **접근 제어:**
  - Private 버킷
  - Pre-signed URL (유효기간: 1시간)
  - CloudFront로만 접근 가능

### 3.7 백그라운드 작업 레이어
#### Celery Workers
- **브로커:** Redis / RabbitMQ
- **백엔드:** Redis
- **작업 유형:**
  - 비디오 트랜스코딩 (우선순위: 높음)
  - 이메일 발송 (우선순위: 중간)
  - 통계 집계 (우선순위: 낮음)
  - 썸네일 생성
  - 수료증 생성

- **워커 구성:**
  - 비디오 처리 워커: 2개 (고사양 인스턴스)
  - 일반 워커: 4개

- **모니터링:** Flower (Celery 모니터링 도구)

## 4. 주요 기능별 아키텍처

### 4.1 비디오 업로드 및 처리 플로우
```
1. [강사] 비디오 업로드 요청
   ↓
2. [백엔드] Pre-signed URL 발급 (S3)
   ↓
3. [강사] 직접 S3에 업로드 (videos-raw)
   ↓
4. [S3] 업로드 완료 이벤트 → Lambda / SQS
   ↓
5. [Celery] 트랜스코딩 작업 시작
   - FFmpeg로 다양한 해상도 생성
   - HLS 세그먼트 생성 (.m3u8, .ts)
   ↓
6. [S3] 처리된 파일 저장 (videos-processed)
   ↓
7. [DB] 비디오 메타데이터 업데이트
   ↓
8. [CloudFront] CDN 캐시 무효화
   ↓
9. [강사] 완료 알림 (이메일/푸시)
```

### 4.2 비디오 스트리밍 플로우
```
1. [학생] 강의 영상 재생 요청
   ↓
2. [백엔드] 수강 여부 확인
   ↓
3. [백엔드] Signed URL 발급 (1시간 유효)
   ↓
4. [프론트엔드] HLS 플레이어로 재생
   ↓
5. [CDN] 비디오 세그먼트 스트리밍
   ↓
6. [프론트엔드] 10초마다 진행도 전송
   ↓
7. [백엔드] Redis에 진행도 임시 저장
   ↓
8. [Celery] 1분마다 DB에 진행도 동기화
```

### 4.3 결제 처리 플로우
```
1. [학생] 강의 구매 요청
   ↓
2. [백엔드] 주문 생성 (status: pending)
   ↓
3. [결제 게이트웨이] Stripe Checkout 세션 생성
   ↓
4. [학생] 카드 정보 입력 및 결제
   ↓
5. [Stripe] Webhook 이벤트 전송
   ↓
6. [백엔드] 결제 확인 및 주문 상태 업데이트
   ↓
7. [DB] 수강 등록 생성
   ↓
8. [Celery] 영수증 이메일 발송
```

## 5. 보안 아키텍처

### 5.1 네트워크 보안
- **VPC 구성:**
  - Public Subnet: Load Balancer
  - Private Subnet: App Servers, DB, Cache
  - NAT Gateway: 외부 API 호출

- **보안 그룹:**
  - ALB: 80(HTTP), 443(HTTPS) 허용
  - App Servers: ALB에서만 접근
  - RDS: App Servers에서만 접근
  - Redis: App Servers에서만 접근

### 5.2 애플리케이션 보안
- **인증/인가:** JWT + Refresh Token
- **비밀번호:** Argon2 해싱
- **API 보안:**
  - Rate Limiting (IP 기반)
  - CORS 설정
  - SQL Injection 방지
  - XSS 방지

### 5.3 데이터 보안
- **전송 중 암호화:** TLS 1.2+
- **저장 시 암호화:**
  - RDS: Encryption at rest
  - S3: SSE-S3 / SSE-KMS
  - Redis: TLS 연결
- **민감 정보:** AWS Secrets Manager

## 6. 모니터링 및 로깅

### 6.1 모니터링
- **APM:** New Relic / Datadog
- **지표:**
  - CPU, Memory, Disk 사용률
  - 요청 응답 시간
  - 에러율
  - 데이터베이스 커넥션 풀

- **알림:**
  - 에러율 > 5%
  - 응답 시간 > 1초
  - CPU > 80%
  - 디스크 > 90%

### 6.2 로깅
- **로그 수집:** Fluentd / Logstash
- **로그 저장:** Elasticsearch / CloudWatch Logs
- **로그 분석:** Kibana / CloudWatch Insights
- **로그 레벨:**
  - ERROR: 즉시 알림
  - WARNING: 일일 리포트
  - INFO: 저장만

### 6.3 분산 추적
- **도구:** Jaeger / AWS X-Ray
- **추적 대상:**
  - API 요청 흐름
  - 데이터베이스 쿼리
  - 외부 API 호출
  - Celery 작업

## 7. 재해 복구 및 백업

### 7.1 백업 전략
- **데이터베이스:**
  - 자동 백업: 매일
  - 스냅샷: 주간
  - 보관: 30일
  - 지역 간 복제

- **S3:**
  - 버전 관리 활성화
  - Cross-Region Replication

### 7.2 장애 복구
- **RTO (Recovery Time Objective):** 1시간
- **RPO (Recovery Point Objective):** 5분
- **DR 전략:**
  - Multi-AZ 배포
  - 자동 장애 조치
  - 정기 DR 훈련 (분기별)

## 8. 성능 최적화

### 8.1 캐싱 전략
- **Redis 캐시:**
  - 강의 목록: 5분
  - 강의 상세: 10분
  - 사용자 프로필: 30분
  - 카테고리: 1시간

- **데이터베이스 쿼리 최적화:**
  - Select Related / Prefetch Related
  - 인덱스 최적화
  - 쿼리 플랜 분석

### 8.2 CDN 최적화
- **Edge Locations:** 전 세계
- **캐시 히트율 목표:** 90%+
- **이미지 최적화:**
  - WebP 포맷
  - Lazy Loading
  - Responsive Images

## 9. 비용 최적화
- **Reserved Instances:** RDS, ElastiCache (1년)
- **Spot Instances:** Celery 워커 (비중요)
- **S3 Lifecycle:** 오래된 파일 Glacier 이동
- **CloudFront:** 요금제 최적화
- **Auto Scaling:** 비용 효율적인 스케일링

## 10. 확장성 고려사항
### 수직 확장 (Scale Up)
- 데이터베이스 인스턴스 타입 증가

### 수평 확장 (Scale Out)
- 애플리케이션 서버 인스턴스 추가
- Read Replica 추가
- Redis 클러스터 확장

### 마이크로서비스 전환 (선택)
- 비디오 처리 서비스 분리
- 결제 서비스 분리
- 검색 서비스 분리
```
